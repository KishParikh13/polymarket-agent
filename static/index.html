<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polymarket AI Viewer</title>
  <style>
    :root {
      --bg:        #0d1117;
      --surface:   #161b22;
      --border:    #30363d;
      --text:      #e6edf3;
      --muted:     #8b949e;
      --accent:    #58a6ff;
      --green:     #3fb950;
      --red:       #f85149;
      --yellow:    #d29922;
      --purple:    #bc8cff;
      --orange:    #ffa657;
      --radius:    8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 14px;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      flex-shrink: 0;
    }
    header h1 span { color: var(--accent); }
    .header-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--muted);
      flex-shrink: 0;
    }
    .header-stats b { color: var(--text); }
    .spacer { flex: 1; }

    /* â”€â”€ Controls â”€â”€ */
    .controls {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    input[type="text"], select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 7px 12px;
      border-radius: var(--radius);
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s;
    }
    input[type="text"]:focus, select:focus {
      border-color: var(--accent);
    }
    input[type="text"] { width: 280px; }
    select { cursor: pointer; }

    .range-group {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .range-group input[type="range"] {
      width: 90px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    .range-val { color: var(--text); font-variant-numeric: tabular-nums; min-width: 36px; }

    .btn {
      padding: 7px 14px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: opacity 0.15s, transform 0.1s;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary   { background: var(--accent);  color: #0d1117; }
    .btn-success   { background: var(--green);   color: #0d1117; }
    .btn-danger    { background: var(--red);     color: #fff;    }
    .btn-secondary { background: var(--border);  color: var(--text); }
    .btn:disabled  { opacity: 0.45; cursor: not-allowed; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }

    /* â”€â”€ Main layout â”€â”€ */
    main { padding: 20px 24px; }

    /* â”€â”€ Status bar â”€â”€ */
    #status-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--muted);
    }
    #status-bar .loader {
      width: 16px; height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      display: none;
    }
    #status-bar.loading .loader { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Table â”€â”€ */
    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      background: var(--surface);
      padding: 10px 14px;
      text-align: left;
      font-weight: 600;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    thead th:hover { color: var(--text); }
    thead th .sort-arrow { margin-left: 4px; opacity: 0.4; }
    thead th.sorted .sort-arrow { opacity: 1; color: var(--accent); }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
    }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(88, 166, 255, 0.04); }

    td {
      padding: 10px 14px;
      vertical-align: middle;
    }

    .q-cell {
      max-width: 420px;
    }
    .q-text {
      font-weight: 500;
      color: var(--text);
      line-height: 1.4;
      cursor: pointer;
    }
    .q-text:hover { color: var(--accent); }
    .q-meta {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Category badge */
    .cat-badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .cat-Crypto     { background: rgba(188, 140, 255, 0.15); color: var(--purple); }
    .cat-Politics   { background: rgba(248, 81, 73, 0.15);   color: var(--red); }
    .cat-Geopolitics{ background: rgba(248, 81, 73, 0.10);   color: #ff8080; }
    .cat-Economics  { background: rgba(255, 166, 87, 0.15);  color: var(--orange); }
    .cat-Sports     { background: rgba(63, 185, 80, 0.15);   color: var(--green); }
    .cat-Business   { background: rgba(88, 166, 255, 0.15);  color: var(--accent); }
    .cat-Tech       { background: rgba(88, 166, 255, 0.10);  color: #7ec8ff; }
    .cat-Other      { background: rgba(139, 148, 158, 0.15); color: var(--muted); }

    /* Price pill */
    .price-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }
    .price-pill.high { background: rgba(63, 185, 80, 0.12);  color: var(--green); }
    .price-pill.mid  { background: rgba(88, 166, 255, 0.12); color: var(--accent); }
    .price-pill.low  { background: rgba(248, 81, 73, 0.12);  color: var(--red); }

    .volume-cell { color: var(--muted); font-variant-numeric: tabular-nums; white-space: nowrap; }
    .days-cell   { color: var(--muted); white-space: nowrap; text-align: center; }
    .days-urgent { color: var(--orange); font-weight: 600; }

    /* â”€â”€ Analysis card (inline) â”€â”€ */
    .analysis-row td {
      padding: 0;
      background: #0a0e14;
      border-top: none;
    }
    .analysis-card {
      padding: 14px 20px;
      border-left: 3px solid var(--border);
      margin: 4px 14px 8px;
      border-radius: 0 var(--radius) var(--radius) 0;
      position: relative;
    }
    .analysis-card.loading {
      border-left-color: var(--accent);
    }
    .analysis-card.signal-YES  { border-left-color: var(--green);  background: rgba(63,185,80,0.04); }
    .analysis-card.signal-NO   { border-left-color: var(--red);    background: rgba(248,81,73,0.04); }
    .analysis-card.signal-PASS { border-left-color: var(--muted);  background: rgba(139,148,158,0.04); }

    .analysis-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    .signal-badge {
      font-size: 15px;
      font-weight: 800;
      padding: 3px 12px;
      border-radius: 6px;
      letter-spacing: 0.05em;
    }
    .signal-badge.YES  { background: rgba(63,185,80,0.2);  color: var(--green); }
    .signal-badge.NO   { background: rgba(248,81,73,0.2);  color: var(--red); }
    .signal-badge.PASS { background: rgba(139,148,158,0.15); color: var(--muted); }

    .analysis-bars {
      display: flex;
      gap: 16px;
      margin-bottom: 8px;
    }
    .bar-group { flex: 1; }
    .bar-label { font-size: 10px; text-transform: uppercase; color: var(--muted); letter-spacing: 0.05em; margin-bottom: 3px; }
    .bar-track {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    .bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
    .bar-fill.prob { background: var(--accent); }
    .bar-fill.conf { background: var(--purple); }
    .bar-nums {
      font-size: 13px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      margin-top: 2px;
    }

    .analysis-reasoning {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    .analysis-reasoning b { color: var(--text); }

    .analysis-spin {
      width: 20px; height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    /* â”€â”€ Empty/error state â”€â”€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .empty-state h3 { font-size: 16px; margin-bottom: 8px; color: var(--text); }

    /* â”€â”€ Tooltip â”€â”€ */
    [title] { cursor: help; }

    /* â”€â”€ Scrollbar â”€â”€ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }
  </style>
</head>
<body>

<header>
  <h1>ğŸ“Š <span>Polymarket</span> AI Viewer</h1>
  <div class="header-stats">
    <span>Markets: <b id="stat-shown">â€”</b> / <b id="stat-total">â€”</b></span>
    <span>Analyzed: <b id="stat-analyzed">0</b></span>
    <span>Last refresh: <b id="stat-refresh">â€”</b></span>
  </div>
  <div class="spacer"></div>
  <button class="btn btn-primary" onclick="loadMarkets()">âŸ³ Refresh</button>
</header>

<div class="controls">
  <!-- Search -->
  <input type="text" id="search" placeholder="ğŸ”  Search marketsâ€¦" oninput="applyFilters()" />

  <!-- Category -->
  <select id="filter-cat" onchange="applyFilters()">
    <option value="">All Categories</option>
    <option>Crypto</option>
    <option>Politics</option>
    <option>Geopolitics</option>
    <option>Economics</option>
    <option>Sports</option>
    <option>Business</option>
    <option>Tech</option>
    <option>Other</option>
  </select>

  <!-- Days left -->
  <select id="filter-days" onchange="applyFilters()">
    <option value="">Any timeframe</option>
    <option value="3">â‰¤ 3 days</option>
    <option value="7">â‰¤ 7 days</option>
    <option value="14">â‰¤ 14 days</option>
    <option value="30">â‰¤ 30 days</option>
  </select>

  <!-- Price range -->
  <div class="range-group">
    <label>YES â‰¥</label>
    <input type="range" id="filter-yes-min" min="0" max="95" value="0" step="5"
           oninput="document.getElementById('yes-min-val').textContent=this.value+'%'; applyFilters()" />
    <span class="range-val" id="yes-min-val">0%</span>
    <label>â‰¤</label>
    <input type="range" id="filter-yes-max" min="5" max="100" value="100" step="5"
           oninput="document.getElementById('yes-max-val').textContent=this.value+'%'; applyFilters()" />
    <span class="range-val" id="yes-max-val">100%</span>
  </div>

  <!-- Min volume -->
  <div class="range-group">
    <label>Vol â‰¥</label>
    <select id="filter-vol" onchange="applyFilters()">
      <option value="0">Any</option>
      <option value="1000">$1K</option>
      <option value="5000">$5K</option>
      <option value="10000">$10K</option>
      <option value="50000">$50K</option>
      <option value="100000">$100K</option>
    </select>
  </div>

  <button class="btn btn-secondary btn-sm" onclick="clearFilters()">âœ• Clear</button>
</div>

<main>
  <div id="status-bar">
    <div class="loader"></div>
    <span id="status-text">Loading marketsâ€¦</span>
  </div>

  <div class="table-wrap" id="table-wrap">
    <table id="markets-table">
      <thead>
        <tr>
          <th onclick="sortBy('category')" title="Category">Cat <span class="sort-arrow">â‡…</span></th>
          <th onclick="sortBy('question')" title="Market question">Question <span class="sort-arrow">â‡…</span></th>
          <th onclick="sortBy('yes_price')" title="Current YES price">YES <span class="sort-arrow">â‡…</span></th>
          <th onclick="sortBy('volume')" title="Total volume">Volume <span class="sort-arrow">â‡…</span></th>
          <th onclick="sortBy('days_left')" title="Days until resolution">Closes <span class="sort-arrow">â‡…</span></th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="markets-body">
        <tr><td colspan="6"><div class="empty-state"><h3>Loadingâ€¦</h3></div></td></tr>
      </tbody>
    </table>
  </div>
</main>

<script>
  let allMarkets = [];
  let filteredMarkets = [];
  let sortKey = 'volume';
  let sortDir = -1; // -1 = desc
  let analyzingIds = new Set();
  let results = {};

  // â”€â”€ Load markets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadMarkets() {
    setStatus('loading', 'Fetching live markets from Polymarketâ€¦');
    try {
      const res = await fetch('/api/markets?limit=300&min_volume=500&max_days=90');
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      allMarkets = data.markets || [];
      document.getElementById('stat-total').textContent = allMarkets.length;
      document.getElementById('stat-refresh').textContent = new Date().toLocaleTimeString();
      applyFilters();
      setStatus('idle', `Loaded ${allMarkets.length} live markets`);
    } catch(e) {
      setStatus('idle', `âŒ Error loading markets: ${e.message}`);
    }
  }

  // â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyFilters() {
    const search   = document.getElementById('search').value.toLowerCase();
    const cat      = document.getElementById('filter-cat').value;
    const daysMax  = parseInt(document.getElementById('filter-days').value) || Infinity;
    const yesMin   = parseFloat(document.getElementById('filter-yes-min').value) / 100;
    const yesMax   = parseFloat(document.getElementById('filter-yes-max').value) / 100;
    const volMin   = parseFloat(document.getElementById('filter-vol').value) || 0;

    filteredMarkets = allMarkets.filter(m => {
      if (search && !m.question.toLowerCase().includes(search)) return false;
      if (cat && m.category !== cat) return false;
      if (m.days_left !== null && m.days_left !== undefined && m.days_left > daysMax) return false;
      if (m.yes_price < yesMin || m.yes_price > yesMax) return false;
      if (m.volume < volMin) return false;
      return true;
    });

    sortMarkets();
    renderTable();
    document.getElementById('stat-shown').textContent = filteredMarkets.length;
  }

  function clearFilters() {
    document.getElementById('search').value = '';
    document.getElementById('filter-cat').value = '';
    document.getElementById('filter-days').value = '';
    document.getElementById('filter-yes-min').value = 0;
    document.getElementById('filter-yes-max').value = 100;
    document.getElementById('yes-min-val').textContent = '0%';
    document.getElementById('yes-max-val').textContent = '100%';
    document.getElementById('filter-vol').value = 0;
    applyFilters();
  }

  // â”€â”€ Sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sortBy(key) {
    if (sortKey === key) sortDir = -sortDir;
    else { sortKey = key; sortDir = key === 'question' ? 1 : -1; }
    sortMarkets();
    renderTable();
    // update arrows
    document.querySelectorAll('thead th').forEach(th => th.classList.remove('sorted'));
    const headers = ['category','question','yes_price','volume','days_left'];
    const idx = headers.indexOf(key);
    if (idx >= 0) {
      const ths = document.querySelectorAll('thead th');
      ths[idx].classList.add('sorted');
      ths[idx].querySelector('.sort-arrow').textContent = sortDir === 1 ? 'â†‘' : 'â†“';
    }
  }

  function sortMarkets() {
    filteredMarkets.sort((a, b) => {
      let av = a[sortKey], bv = b[sortKey];
      if (av === null || av === undefined) av = sortDir === 1 ? Infinity : -Infinity;
      if (bv === null || bv === undefined) bv = sortDir === 1 ? Infinity : -Infinity;
      if (typeof av === 'string') return sortDir * av.localeCompare(bv);
      return sortDir * (av - bv);
    });
  }

  // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable() {
    const tbody = document.getElementById('markets-body');
    if (filteredMarkets.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state">
        <h3>No markets match your filters</h3>
        <p>Try relaxing the search or filter criteria.</p>
      </div></td></tr>`;
      return;
    }

    tbody.innerHTML = '';
    for (const m of filteredMarkets) {
      // Market row
      const tr = document.createElement('tr');
      tr.id = `row-${m.id}`;
      tr.innerHTML = buildMarketRow(m);
      tbody.appendChild(tr);

      // Analysis row (hidden until analyzed)
      const aTr = document.createElement('tr');
      aTr.id = `analysis-${m.id}`;
      aTr.className = 'analysis-row';
      aTr.style.display = 'none';
      aTr.innerHTML = `<td colspan="6"></td>`;
      tbody.appendChild(aTr);

      // If already analyzed, restore result
      if (results[m.id]) {
        showResult(m.id, results[m.id]);
      }
    }
  }

  function buildMarketRow(m) {
    const yp = m.yes_price;
    const priceClass = yp >= 0.6 ? 'high' : yp <= 0.4 ? 'low' : 'mid';
    const priceLabel = (yp * 100).toFixed(1) + '%';

    const vol = m.volume >= 1_000_000
      ? '$' + (m.volume/1_000_000).toFixed(1) + 'M'
      : m.volume >= 1_000
      ? '$' + (m.volume/1_000).toFixed(1) + 'K'
      : '$' + m.volume.toFixed(0);

    const days = m.days_left;
    const daysStr = days === null || days === undefined
      ? 'â€”'
      : days === 0 ? 'Today'
      : days === 1 ? '1 day'
      : `${days} days`;
    const daysClass = (days !== null && days !== undefined && days <= 7) ? 'days-urgent' : '';

    const cat = m.category || 'Other';
    const qShort = m.question.length > 90 ? m.question.slice(0, 90) + 'â€¦' : m.question;

    const isAnalyzing = analyzingIds.has(m.id);
    const res = results[m.id];
    const btnLabel = isAnalyzing ? 'â³ Analyzingâ€¦'
                   : res ? 'ğŸ”„ Re-analyze'
                   : 'ğŸ¤– Analyze';
    const btnClass = res ? 'btn-secondary' : 'btn-primary';

    return `
      <td><span class="cat-badge cat-${cat}">${cat}</span></td>
      <td class="q-cell">
        <div class="q-text" onclick="toggleAnalysis('${m.id}')" title="${escHtml(m.question)}">${escHtml(qShort)}</div>
        <div class="q-meta">ID: ${m.id.slice(0,8)}â€¦</div>
      </td>
      <td><span class="price-pill ${priceClass}">${priceLabel}</span></td>
      <td class="volume-cell">${vol}</td>
      <td class="days-cell ${daysClass}">${daysStr}</td>
      <td>
        <button class="btn ${btnClass} btn-sm" id="btn-${m.id}"
          onclick="analyzeMarket(${JSON.stringify(m).replace(/"/g, '&quot;')})"
          ${isAnalyzing ? 'disabled' : ''}>
          ${btnLabel}
        </button>
      </td>
    `;
  }

  // â”€â”€ Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function analyzeMarket(m) {
    if (analyzingIds.has(m.id)) return;
    analyzingIds.add(m.id);

    // Update button
    const btn = document.getElementById(`btn-${m.id}`);
    if (btn) { btn.disabled = true; btn.textContent = 'â³ Analyzingâ€¦'; }

    // Show loading card
    const aTr = document.getElementById(`analysis-${m.id}`);
    if (aTr) {
      aTr.style.display = '';
      aTr.querySelector('td').innerHTML = `
        <div class="analysis-card loading">
          <span class="analysis-spin"></span>
          <span style="color:var(--muted); font-size:13px">Running AI analysis on <b style="color:var(--text)">${escHtml(m.question.slice(0,60))}â€¦</b></span>
        </div>`;
    }

    try {
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(m),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({detail: res.statusText}));
        throw new Error(err.detail || res.statusText);
      }
      const data = await res.json();
      results[m.id] = data;
      document.getElementById('stat-analyzed').textContent = Object.keys(results).length;
      showResult(m.id, data);
    } catch(e) {
      if (aTr) {
        aTr.querySelector('td').innerHTML = `
          <div class="analysis-card signal-PASS">
            <span style="color:var(--red)">âŒ Analysis failed: ${escHtml(e.message)}</span>
          </div>`;
      }
    } finally {
      analyzingIds.delete(m.id);
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ Re-analyze';
        btn.className = 'btn btn-secondary btn-sm';
      }
    }
  }

  function showResult(id, data) {
    const aTr = document.getElementById(`analysis-${id}`);
    if (!aTr) return;

    const sig = data.signal;
    const prob = (data.probability * 100).toFixed(1);
    const conf = (data.confidence * 100).toFixed(1);
    const mktP = (data.yes_price * 100).toFixed(1);

    const sigIcon = sig === 'YES' ? 'âœ…' : sig === 'NO' ? 'âŒ' : 'â­ï¸';
    const sigColor = sig === 'YES' ? 'var(--green)' : sig === 'NO' ? 'var(--red)' : 'var(--muted)';

    aTr.style.display = '';
    aTr.querySelector('td').innerHTML = `
      <div class="analysis-card signal-${sig}">
        <div class="analysis-header">
          <span class="signal-badge ${sig}">${sigIcon} ${sig}</span>
          <span style="color:var(--muted); font-size:12px">${escHtml(data.signal_reason)}</span>
          <button class="btn btn-secondary btn-sm" style="margin-left:auto"
            onclick="document.getElementById('analysis-${id}').style.display='none'">âœ•</button>
        </div>
        <div class="analysis-bars">
          <div class="bar-group">
            <div class="bar-label">Model Probability</div>
            <div class="bar-track"><div class="bar-fill prob" style="width:${prob}%"></div></div>
            <div class="bar-nums" style="color:var(--accent)">${prob}%</div>
          </div>
          <div class="bar-group">
            <div class="bar-label">Market Price</div>
            <div class="bar-track"><div class="bar-fill prob" style="width:${mktP}%; opacity:0.4"></div></div>
            <div class="bar-nums" style="color:var(--muted)">${mktP}%</div>
          </div>
          <div class="bar-group">
            <div class="bar-label">Confidence</div>
            <div class="bar-track"><div class="bar-fill conf" style="width:${conf}%"></div></div>
            <div class="bar-nums" style="color:var(--purple)">${conf}%</div>
          </div>
        </div>
        <div class="analysis-reasoning">
          <b>Reasoning:</b> ${escHtml(data.reasoning)}
        </div>
        <div style="font-size:11px; color:var(--muted); margin-top:6px">
          Model: ${escHtml(data.model)} Â· Market YES: ${mktP}% Â· Model YES: ${prob}%
        </div>
      </div>`;
  }

  function toggleAnalysis(id) {
    const aTr = document.getElementById(`analysis-${id}`);
    if (!aTr) return;
    if (aTr.style.display === 'none') {
      if (results[id]) { aTr.style.display = ''; }
    } else {
      aTr.style.display = 'none';
    }
  }

  // â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(state, msg) {
    const bar = document.getElementById('status-bar');
    document.getElementById('status-text').textContent = msg;
    if (state === 'loading') bar.classList.add('loading');
    else bar.classList.remove('loading');
  }

  // â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function escHtml(str) {
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadMarkets();
</script>
</body>
</html>
